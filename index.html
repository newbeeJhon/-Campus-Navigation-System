<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Navigator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 90vh; width: 100%; }
    #searchBar {
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #errorMsg {
      color: red;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="searchBar">
    <select id="buildingSelect">
      <option value="">-- Select a building --</option>
    </select>
    <button onclick="findBuilding()">Find</button>
  </div>
  <div id="errorMsg"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([14.5995, 120.9842], 17); // default Manila
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let userMarker;
    let routeLayer;
    let buildings = {};
    let buildingMarkers = [];

    // Show error messages on screen
    function showError(msg) {
      document.getElementById("errorMsg").innerText = msg;
    }

    // Get user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          userMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("You are here").openPopup();
          map.setView([latitude, longitude], 18);
        },
        err => {
          console.error("Geolocation error:", err);
          if (err.code === 1) showError("Location access denied. Please allow GPS.");
          else if (err.code === 2) showError("Location unavailable. Try again.");
          else if (err.code === 3) showError("Location request timed out.");
          else showError("Unable to fetch your location.");
        },
        { enableHighAccuracy: true }
      );
    } else {
      showError("Geolocation is not supported by your browser.");
    }

    // Load buildings.json
    fetch("buildings.json")
      .then(res => res.json())
      .then(data => {
        buildings = data;
        populateDropdown();
        showAllBuildingMarkers();
      })
      .catch(() => {
        buildings = {
          "Library": { lat: 14.5995, lng: 120.9842 },
          "Canteen": { lat: 14.6000, lng: 120.9850 }
        };
        populateDropdown();
        showAllBuildingMarkers();
        showError("Could not load buildings.json, using demo data.");
      });

    // Populate dropdown with buildings
    function populateDropdown() {
      const select = document.getElementById("buildingSelect");
      Object.keys(buildings).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    }

    // Show markers for all buildings
    function showAllBuildingMarkers() {
      buildingMarkers.forEach(m => map.removeLayer(m));
      buildingMarkers = [];

      Object.entries(buildings).forEach(([name, coords]) => {
        const marker = L.marker([coords.lat, coords.lng]).addTo(map).bindPopup(name);
        buildingMarkers.push(marker);
      });
    }

    function findBuilding() {
      const query = document.getElementById("buildingSelect").value;
      if (!query || !buildings[query]) {
        showError("Building not found. Try another.");
        return;
      }

      const { lat, lng } = buildings[query];
      map.setView([lat, lng], 18);

      // Draw route if user location is known
      if (userMarker) {
        const userLatLng = userMarker.getLatLng();
        if (routeLayer) map.removeLayer(routeLayer);

        fetch(`https://router.project-osrm.org/route/v1/walking/${userLatLng.lng},${userLatLng.lat};${lng},${lat}?overview=full&geometries=geojson`)
          .then(res => res.json())
          .then(data => {
            if (data.routes.length) {
              routeLayer = L.geoJSON(data.routes[0].geometry).addTo(map);
            } else {
              showError("No walking route found.");
            }
          })
          .catch(() => showError("Error fetching route."));
      } else {
        showError("User location not available, cannot draw route.");
      }
    }
  </script>
</body>
</html>
